"""
This is the main driver of the CVE Process class.
"""
import gzip
import json

import requests

from config import CONFIG
from controllers import dynamoDBO, mitre_db
from models import cve

settings = CONFIG()
dbo = dynamoDBO.dynamo(config=settings.settings['dbo'])
nvd_cve = mitre_db.nvd_lookup()


def process_easy_os():
    """
    This funciton will process any of the Easy OS CVE's that are present
    :return:
    """
    items = dbo.query_cve_meta_keys(key="type", value="operating_system")
    #pre-process filter
    stats={
        "ToProcess": {"count": 0, "critical": 0, "high": 0, "medium": 0, "low": 0, "toSkip": 0},
        "Processed": {"count": 0, "critical": 0, "high": 0, "medium": 0, "low": 0, "toSkip": 0},
        "Errors": {}
    }

    for item in items:
        if 'processed' not in item:
            stats = __stats(current_stats=stats, cve_meta=item)
            processed=__process_cve_ez_os(item)
            if processed:
                stats['Processed']['count'] = stats['Processed']['count'] + 1
                item['processed'] = True
                dbo.put_item(table_name='cve_meta', item=item)

    print(json.dumps(stats, indent=2))


def process_easy_app():
    items = dbo.query_cve_meta_keys(key="type", value="ez-application")
    for item in items:
        # This is a place holder right now.
        cve_details = nvd_cve.look_up(item['cve_id'])



def __stats (current_stats, cve_meta):
    current_stats['ToProcess']['count'] = current_stats['ToProcess']['count'] + 1
    if cve_meta['cvss_severity'] == "CRITICAL":
        current_stats['ToProcess']['critical'] = current_stats['ToProcess']['critical'] + 1
    if cve_meta['cvss_severity'] == "HIGH":
        current_stats['ToProcess']['high'] = current_stats['ToProcess']['high'] + 1
    if cve_meta['cvss_severity'] == "MEDIUM":
        current_stats['ToProcess']['medium'] = current_stats['ToProcess']['medium'] + 1
    if cve_meta['cvss_severity'] == "LOW":
        current_stats['ToProcess']['low'] = current_stats['ToProcess']['low'] + 1
    return current_stats


def __process_cve_ez_app(cve_meta = {})->bool:
    if cve_meta == {}:
        return False
    cve_details = nvd_cve.look_up(cve_id=cve_meta['cve_id'])
    cvo = cve.CVE(cve_details)
    cvo.process_cve()


def __process_cve_ez_os(cve_meta = {})-> bool:
    if cve_meta == {}:
        return False
    cve_details = nvd_cve.look_up(cve_id=cve_meta['cve_id'])
    cvo = cve.CVE(cve_details)
    cvo.process_cve()
    for os in cvo.vulnerable_os:
        if os['os'] == 'mac_os_x':
            os['os'] = 'macos'
        item = {'cve_os':f'{cve_meta["cve_id"]}_{os["os"]}','os': os['os'],'meta': cve_meta}
        if 'versionEndExcluding' in os:
            item['versionEndExcluding'] = os['versionEndExcluding']
        if 'versionStartIncluding' in os:
            item['versionStartIncluding'] = os['versionStartIncluding']
        if 'versionEndExcluding' not in item and 'versionStartIncluding' not in item:
            print("error")
        print(item)
        dbo.put_item(table_name='cve_os_pairing',item=item)
    return True


if __name__ == "__main__":
    """
    Running from here.
    """

    easy_os = False
    easy_app = True
    complex_app = False

    if easy_os:
        process_easy_os()

    if easy_app:
        process_easy_app()