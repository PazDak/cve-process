"""
This is the main driver of the CVE Process class.
"""
import gzip
import json

import requests

from config import CONFIG
from controllers import dynamoDBO, mitre_db
from models import cve, software_match


settings = CONFIG()
dbo = dynamoDBO.dynamo(config=settings.settings['dbo'])
nvd_cve = mitre_db.nvd_lookup()


def process_easy_os():
    """
    This funciton will process any of the Easy OS CVE's that are present
    :return:
    """
    items = dbo.query_cve_meta_keys(key="type", value="operating_system")
    #pre-process filter
    stats={
        "ToProcess": {"count": 0, "critical": 0, "high": 0, "medium": 0, "low": 0, "toSkip": 0},
        "Processed": {"count": 0, "critical": 0, "high": 0, "medium": 0, "low": 0, "toSkip": 0},
        "Errors": {}
    }

    for item in items:
        if 'processed' not in item:
            stats = __stats(current_stats=stats, cve_meta=item)
            processed=__process_cve_ez_os(item)
            if processed:
                stats['Processed']['count'] = stats['Processed']['count'] + 1
                item['processed'] = True
                dbo.put_item(table_name='cve_meta', item=item)

    print(json.dumps(stats, indent=2))


def process_easy_app():
    items = dbo.query_cve_meta_keys(key="type", value="ez-application")
    for item in items:
        # This is a place holder right now.
        cve_details = nvd_cve.look_up(item['cve_id'])

def process_easy_cve(cve_id = ""):
    cve_meta = dbo.query_cve_meta(cve_id=cve_id)[0]
    if 'type' in cve_meta:
        if cve_meta['type'] == 'ez-application':
            processed = __process_cve_ez_app(cve_meta = cve_meta)


def __stats (current_stats, cve_meta):
    current_stats['ToProcess']['count'] = current_stats['ToProcess']['count'] + 1
    if cve_meta['cvss_severity'] == "CRITICAL":
        current_stats['ToProcess']['critical'] = current_stats['ToProcess']['critical'] + 1
    if cve_meta['cvss_severity'] == "HIGH":
        current_stats['ToProcess']['high'] = current_stats['ToProcess']['high'] + 1
    if cve_meta['cvss_severity'] == "MEDIUM":
        current_stats['ToProcess']['medium'] = current_stats['ToProcess']['medium'] + 1
    if cve_meta['cvss_severity'] == "LOW":
        current_stats['ToProcess']['low'] = current_stats['ToProcess']['low'] + 1
    return current_stats


def __process_cve_ez_app(cve_meta = {})->bool:
    print("start process ez app")
    if cve_meta == {}:
        return False
    cve_details = nvd_cve.look_up(cve_id=cve_meta['cve_id'])
    cvo = cve.CVE(cve_details)
    cvo.process_cve()
    nodes = cvo.ez_app_nodes
    for node in nodes:
        match = software_match.softwareTitleMatch(cpe_string=node["cpe23Uri"])
        sw_match = dbo.query_cve_software_paring(match.software_hash)[0]
        print(sw_match)
        match = None
        for cve_node in sw_match['cve_list']:
            if cve_node['cve_id'] == cve_meta['cve_id']:
                match = True

        if not match:
            new_meta = {
                "cve_id": cve_meta['cve_id'],
                "cvss": cve_meta['cvss'],
                "cvss_severity": cve_meta['cvss_severity'],
            }
            version_strings = ['versionStartIncluding','versionEndExcluding','versionEndIncluding','versionStartIncluding']
            for version_string in version_strings:
                if version_string in node:
                    new_meta[version_string] = node[version_string]

            sw_match['cve_list'].append(new_meta)
            print(sw_match)
            dbo.put_item(table_name="cve_software_match", item=sw_match)
    return True


def __process_cve_ez_os(cve_meta = {})-> bool:
    if cve_meta == {}:
        return False
    cve_details = nvd_cve.look_up(cve_id=cve_meta['cve_id'])
    cvo = cve.CVE(cve_details)
    cvo.process_cve()
    for os in cvo.vulnerable_os:
        if os['os'] == 'mac_os_x':
            os['os'] = 'macos'
        item = {'cve_os':f'{cve_meta["cve_id"]}_{os["os"]}','os': os['os'],'meta': cve_meta}
        if 'versionEndExcluding' in os:
            item['versionEndExcluding'] = os['versionEndExcluding']
        if 'versionStartIncluding' in os:
            item['versionStartIncluding'] = os['versionStartIncluding']
        if 'versionEndExcluding' not in item and 'versionStartIncluding' not in item:
            print("error")
        print(item)
        dbo.put_item(table_name='cve_os_pairing', item=item)
    return True


if __name__ == "__main__":
    """
    Running from here.
    """
    proces_cve = "CVE-2020-26085"
    easy_os = False
    easy_app = False
    complex_app = False

    if proces_cve == "CVE-2020-26085":
        process_easy_cve(cve_id=proces_cve)

    if easy_os:
        process_easy_os()

    if easy_app:
        process_easy_app()