"""
This Class is a models class for CVE's that houses common
"""

import hashlib
import json


class CVE:
    """
    This class is a CVE object
    """
    details: dict
    meta: dict
    monitor: bool

    supported_os_list = ['ipad_os', 'iphone_os', 'tvos', 'mac_os_x', 'macos']

    vulnerable_os = list()
    vulnerable_app = list()
    cpe_strings = list()

    def __init__(self, details=None):
        if details:
            self.details = details
            if self._sniff_check(nist_dict=details):
                self.monitor = True
                self._build_meta()
                # self._check_config(configurations=details['configurations'])
            else:
                self.monitor = False

    def process_cve(self):
        self._check_config(configurations=self.details['configurations'])

    def get_nodes_ez_app(self):
        node_list = list()
        allowed_os = ['mac_os_x', 'macos', 'iphone_os', 'tvos', 'ipad_os', '*']
        jamf_os = ['mac_os_x', 'macos', 'iphone_os', 'tvos', 'ipad_os']
        #print(json.dumps(self.details, indent=2))
        for node in self.details['configurations']['nodes'][0]['cpe_match']:
            if node['vulnerable']:
                if node['cpe23Uri'] not in self.cpe_strings:
                    self.cpe_strings.append(node['cpe23Uri'])
                s = node['cpe23Uri'].split(":")

                if 'a' == s[2] and s[10] in allowed_os:
                    snode = {
                        "vendor": s[3],
                        "appUri": s[4]
                    }
                    if s[10] in jamf_os:
                        snode['os'] = s[10]
                    if 'versionEndExcluding' in node:
                        snode['versionEndExcluding'] = node['versionEndExcluding']
                    if 'versionStartIncluding' in node:
                        snode['versionStartIncluding'] = node['versionStartIncluding']
                    if 'versionEndIncluding' in node:
                        print("error will robbinson")
                        snode['versionEndIncluding'] = node['versionEndIncluding']
                    node_list.append(snode)
        return node_list

    def _build_meta(self):
        self.meta = {
            'cve_id': self.details['cve']['CVE_data_meta']['ID'],
            'cvss': int(self.details['impact']['baseMetricV3']['cvssV3']['baseScore'] * 10),
            'cvss_severity': self.details['impact']['baseMetricV3']['cvssV3']['baseSeverity'],
            'publishedDate': self.details['publishedDate'],
            'lastModifiedDate': self.details['lastModifiedDate'],
            'config_hs': str(hashlib.md5(json.dumps(self.details['configurations']).encode('utf-8')).hexdigest()),
            'monitor': self.monitor
        }

    def _check_config(self, configurations: dict):
        if not configurations:
            return ""

        # Easy mode, OS Version Stored in
        if 'cpe_match' in configurations['nodes'][0] and configurations['nodes'].__len__() == 1 and \
                configurations['nodes'][0]['operator'] == 'OR':
            self._remove_none_jamf()
            if json.dumps(self.details['configurations']['nodes']).__contains__("cpe:2.3:a") and not json.dumps(self.details['configurations']['nodes']).__contains__("cpe:2.3:o"):
                print("got here")
                cpe_nodes = list()
                self.meta['type'] = 'ez-application'
                for node in self.details['configurations']['nodes'][0]['cpe_match']:
                    print(node)
                    cpe_nodes.append(node)
                self.ez_app_nodes = cpe_nodes
            else:
                os_list = list()
                self.meta['type'] = 'operating_system'
                for node in self.details['configurations']['nodes'][0]['cpe_match']:
                    os_list.append(self._extract_os_cpe_node(node))
                self.vulnerable_os = os_list

    def __extract_cpe_node(self, cpe_node):
        if "cpe23Uri" not in cpe_node:
            return None
        item = {}
        cpe_s = cpe_node['cpe23Uri'].split(":")
        if cpe_s[2] == "a":
            "Process application System"
            item = {
                "vendor": cpe_s[3],
                "app_name": cpe_s[4]
            }
            if 'versionEndExcluding' in cpe_node:
                item['versionEndExcluding'] = cpe_node['versionEndExcluding']
            if 'versionStartIncluding' in cpe_node:
                item['versionStartIncluding'] = cpe_node['versionStartIncluding']

        elif cpe_s[2] == "o":
            print("caught an OS")
            return self._extract_os_cpe_node(cpe_node)

        return item


    def _extract_os_cpe_node(self, cpe_node):
        # Guard Statement
        if "cpe23Uri" not in cpe_node:
            return None
        cpe_s = cpe_node['cpe23Uri'].split(":")
        item = {}
        if cpe_s[2] == "o":
            "Process Operating System"
            item = {
                "vendor": cpe_s[3],
                "os": cpe_s[4]
            }
            if 'versionEndExcluding' in cpe_node:
                item['versionEndExcluding'] = cpe_node['versionEndExcluding']
            if 'versionStartIncluding' in cpe_node:
                item['versionStartIncluding'] = cpe_node['versionStartIncluding']
        return item

    def _remove_none_jamf(self):
        parse_node = self.details['configurations']
        for i in range(len(parse_node['nodes'])):
            node = parse_node['nodes'][i]
            if 'cpe_match' in node:
                # Removes the Nodes that do not support Apple Operating Systems.
                parse_node['nodes'][i]['cpe_match'] = list(filter(lambda ii: self._check_cpe23uri(ii['cpe23Uri']),
                                                                  parse_node['nodes'][i]['cpe_match']))
        self.details['configurations'] = parse_node

    def _check_cpe23uri(self, uri) -> bool:
        uris = uri.split(':')
        if uris[2] == 'o':
            # Process as an operating system
            if uris[3] == 'apple':
                if uris[4] in self.supported_os_list:
                    return True
                return False
            return False

        if uris[2] == 'a':
            if uris[10] == '*':
                return True
            elif uris[10] in self.supported_os_list:
                return True
            return False
        return False

    def _build_from_nist(self, nist_dict) -> bool:
        # sniff test

        pass

    def _sniff_check(self, nist_dict) -> bool:
        """
        Uses a quick Sniff to check if the CVE could match a system JAMF mananages
        :param cve: a Dictionary of the MITRE CVE
        :return: True if matching criteria are met.
        """
        # ToDo Switch to a Node Processing system
        cpe_match_strings = []
        cpe_match_strings.append("iphone_os")  # iPhones
        cpe_match_strings.append("tvos")  # AppleTv
        cpe_match_strings.append("mac_os_x")  # MacOS
        cpe_match_strings.append("macos")  # MacOS
        cpe_match_strings.append("ipad_os")  # iPad

        for cpe in cpe_match_strings:
            if json.dumps(nist_dict).__contains__(cpe):
                return True
        return False
