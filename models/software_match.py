import hashlib
import json

class softwareTitleMatch():
    type = ""
    software_hash = ""
    cpe_vendor = ""
    cpe_title = ""
    macos = False
    iphone_os = False
    tvos = False
    ipados = False
    app_name = ""
    kinobi = False
    kinobi_details = {}
    cve_list = []

    def __init__(self, cpe_string="", os=""):
        if cpe_string != "":
            if os.lower() == "macos" or os.lower() == "mac_os_x":
                self.macos = True
            if os.lower() == "iphone_os":
                self.iphone_os = True
            if os.lower() == "ipad_os":
                self.ipados = True
            if os.lower() == "ipados":
                self.ipados = True
            if os.lower() == "tvos":
                self.tvos = True
            if os == "":
                self.__check_embedded_os(cpe_string=cpe_string)
            cpe = cpe_string.split(":")

            if cpe[2] == 'a':
                self.type = "application"
            if cpe[2] == 'o':
                self.type = "os"
            self.cpe_vendor = cpe[3]
            self.cpe_title = cpe[4]
            self.__generate_hash()

    def __generate_hash(self):
        s = f'{self.cpe_vendor}{self.cpe_title}{self.macos}{self.iphone_os}{self.ipados}{self.tvos}'
        # print(s.lower())
        result = hashlib.md5(s.lower().encode())

        self.software_hash = result.hexdigest()

    def __check_embedded_os(self, cpe_string):
        s = cpe_string.split(':')
        # print(s[10])
        string_os = s[10]
        if string_os == "macos" or string_os == "mac_os_x":
            self.macos = True
        if string_os == "iphone_os":
            self.iphone_os = True
        if string_os.lower() == "ipad_os":
            self.ipados = True
        if string_os.lower() == "tvos":
            self.tvos = True
        if string_os.lower() == "*":
            return False

    def isValid(self) -> bool:
        if self.macos:
            # print(self.macos)
            return True
        if self.tvos:
            return True
        if self.ipados:
            return True
        if self.iphone_os:
            return True
        return False

    def toDynamoItem(self):
        item = {
            "software_hash": self.software_hash,
            "cpe_vendor": self.cpe_vendor,
            "cpe_title": self.cpe_title,
            "macos": self.macos,
            "iphone_os": self.iphone_os,
            "tvos": self.tvos,
            "ipados": self.ipados,
            "app_name": self.app_name,
            "kinobi": self.kinobi,
            "cve_list": self.cve_list
        }
        return item

    def fromDynamoItem(self, item):

        # self.software_hash = item['software_hash']
        self.cpe_vendor = item['cpe_vendor']
        self.cpe_title = item['cpe_title']
        self.macos = item['macos']
        self.iphone_os = item['iphone_os']
        self.tvos = item['tvos']
        self.ipados = item['ipados']
        self.app_name = item['app_name']
        self.kinobi = item['kinobi']
        self.cve_list = item['cve_list']
        if 'kinobi_details' in item:
            self.kinobi_details = item['kinobi_details']
        self.__generate_hash()

    def toJSON(self):
        item = {
            "software_hash": self.software_hash,
            "cpe_vendor": self.cpe_vendor,
            "cpe_title": self.cpe_title,
            "macos": self.macos,
            "iphone_os": self.iphone_os,
            "tvos": self.tvos,
            "ipados": self.ipados,
            "app_name": self.app_name,
            "kinobi": self.kinobi,
        }

        new_cve_list = []
        for cve in self.cve_list:
            s = {}
            for key in cve:
                if key == "cvss":
                    s[key] = int(cve[key])
                else:
                    s[key] = cve[key]
            new_cve_list.append(s)
        item["cve_list"] = new_cve_list

        return item