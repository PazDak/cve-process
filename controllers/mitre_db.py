"""
This function will return CVE's directly from MITRE and has a caching engine
"""

import gzip
import json
import time

import requests


class nvd_lookup():
    """
    This class allows you to pull CVE's directly from the NVD database
    """

    cves = {
        "first_entry": "",
        "last_updated": "",
        "items": {

        }
    }

    cache_meta = {
        "count": 0
    }
    cached_years = []

    def __init__(self):
        pass

    def look_up(self, cve_id=""):
        try:
            response = self.cves['items'][cve_id]
        except KeyError:
            year = cve_id.split("-")[1]
            self.cache_from_year(year=int(year))
            response = self.look_up(cve_id=cve_id)

        return response

    def purge_cache(self):
        self.cves = {
                "first_entry": "",
                "last_updated": "",
                "items": {
                }
            }
        self.cache_meta = {
                "count": 0
            }

    def __sniff_test(self, nist_dict) -> bool:
        """
        Uses a quick Sniff to check if the CVE could match a system JAMF mananages
        :param cve: a Dictionary of the MITRE CVE
        :return: True if matching criteria are met.
        """
        cpe_match_strings = []
        cpe_match_strings.append("iphone_os")  # iPhones
        cpe_match_strings.append("tvos")  # AppleTv
        cpe_match_strings.append("mac_os_x")  # MacOS
        cpe_match_strings.append("macos")  # MacOS
        cpe_match_strings.append("ipad_os")  # iPad

        for cpe in cpe_match_strings:
            if json.dumps(nist_dict).__contains__(cpe):
                return True
        return False

    def cache_from_year(self, year):
        cve_items = self.__get_cves_by_year(year)
        cached = 0
        skipped = 0
        for cve in cve_items:
            if self.__sniff_test(cve):
                self.cves['items'][cve['cve']['CVE_data_meta']['ID']] = cve
                cached = cached + 1
            else:
                skipped = skipped +1
        print(f"cached {cached}, skipped {skipped}")

    def __get_cves_by_year(self, year=0):
        #Guard Statement
        if year < 2018 or year > 2021:
            return None
        print(f"caching year: {year}")
        url = f"https://nvd.nist.gov/feeds/json/cve/1.1/nvdcve-1.1-{year}.json.gz"
        response = requests.get(url)
        if response.status_code == 200:
            results = gzip.decompress(response.content)
            return json.loads(results)['CVE_Items']

        return {}

